<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>Ejercicio de bloques y concurrencia (3 puntos en total)</title>
	</head>
<body>
<h2>Ejercicio de bloques y concurrencia (3 puntos en total)</h2>

<p>Vamos a realizar una pequeña aplicación para consultar el tiempo meteorológico. La aplicación terminada tendrá el aspecto que se muestra en la figura</p>

<figure><img src="Captura%20de%20pantalla%202015-10-07%20a%20las%2011.23.39.png"/></figure>

<h3>Creación de la interfaz (1 punto)</h3>

<p>Como se ve en la figura, la interfaz tiene 4 componentes, seleccionables mediante el panel de componentes gráficos de la esquina inferior derecha de Xcode:</p>

<ul>
	<li>Una imagen (<em>image view</em>), para mostrar un icono con el estado del tiempo. Inicialmente estará vacía</li>
	<li>Una etiqueta (<em>label</em>), para mostrar el estado del tiempo de forma textual. Inicialmente estará vacía</li>
	<li>Un campo de texto de 1 línea, para teclear la localidad (<em>text field</em>)</li>
	<li>Un botón pulsable (<em>button</em>) que pondrá “Consultar tiempo” </li>
</ul>

<p>Como ya hiciste en la aplicación de UADivino, conecta los componentes de la interfaz con el <code>ViewController</code>:</p>

<ul>
	<li><strong>Outlets:</strong> recuerda que son componentes de la interfaz a los que quieres acceder para consultar/modificar sus propiedades. Se crean con <code>Ctrl+arrastrar</code> desde el componente hasta el <code>ViewController.h</code>, y cada uno generará un <code>@property</code>. <strong>Crea <em>outlets</em> para la imagen, la etiqueta y el campo de texto</strong></li>
	<li><strong>Action:</strong> recuerda que sirve para ejecutar tu código en respuesta a eventos sobre la interfaz. Se crean igual que los <em>outlets</em> pero arrastrando hasta el <code>ViewController.m</code>. Cada <em>action</em> genera un método. <strong>Crea un <em>action</em> para el botón de “consultar tiempo”</strong></li>
</ul>

<h3>Consulta del tiempo en la consola de depuración (0,5 puntos)</h3>

<p>El estado del tiempo nos lo da un servicio externo, <a href="http://openweather.org">Openweather</a>, que además de la web ofrece el API que vamos a usar.</p>

<p>Para obtener el tiempo en una localidad, con los mensajes traducidos a español y usando unidades del sistema métrico, hay que hacer una petición HTTP a la URL <code>http://api.openweathermap.org/data/2.5/weather?lang=es&amp;units=metric&amp;q=</code>concatenándole la localidad a buscar. Por ejemplo si clicas en <a href="http://api.openweathermap.org/data/2.5/weather?lang=es&amp;units=metric&amp;q=Alicante">este enlace</a> verás el tiempo para Alicante. El API devuelve los datos en formato JSON, que habrá que analizar para extraer la información que nos interese.</p>

<blockquote>
<p>IMPORTANTE: la última versión de iOS tiene una característica llamada “Application Transport Security”, que impide realizar peticiones HTTP desde el código. Solo se pueden hacer peticiones HTTPS. Para poder saltarnos esta restricción tenemos que modificar el archivo <code>info.plist</code> del proyecto:</p>

<p>Pulsa con el botón derecho sobre dicho archivo y elige <code>Open As &gt; Source Code</code>.</p>

<p>Despúes de la etiqueta <code>&lt;dict&gt;</code> de la línea 4 inserta estas líneas:</p>
</blockquote>

<pre><code>&lt;key&gt;NSAppTransportSecurity&lt;/key&gt;
&lt;dict&gt;
  &lt;key&gt;NSAllowsArbitraryLoads&lt;/key&gt;&lt;true/&gt;
&lt;/dict&gt;
</code></pre>

<p>Para hacer una petición HTTP en iOS podemos usar la clase <code>NSURLSession</code>. Copia el siguiente código en el <em>action</em> asociado al botón y adáptalo a tus necesidades:</p>

<pre><code>//IMPORTANTE: la siguiente sentencia asume que la localidad a consultar
//está en la variable &quot;localidad&quot;. Cambia el código si lo necesitas

//stringWithFormat es similar al &quot;sprintf&quot; de C, sirve
//para montar una cadena con varios elementos con el formato deseado
NSString *cadQuery = [NSString stringWithFormat:@&quot;http://api.openweathermap.org/data/2.5/weather?lang=es&amp;units=metric&amp;q=%@&quot;, localidad];
//Para conectarnos necesitamos un objeto NSURL
NSURL *urlQuery = [NSURL URLWithString:cadQuery];
//Los parámetros de la conexión son los usados &quot;por defecto&quot;
NSURLSession *sesion = [NSURLSession sharedSession];
//Un DataTask es una petición. Cuando se completa, se llama al &quot;completionHandler&quot;
NSURLSessionDataTask *tarea = [sesion
          dataTaskWithURL:urlQuery
          completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
              //Convertimos el JSON en un NSDictionary
              NSDictionary *json = [NSJSONSerialization JSONObjectWithData:data options:0 error:nil];
              NSLog(@&quot;%@&quot;, json);
           }];
//Lo anterior solo define la petición. Esto la inicia
[tarea resume];
</code></pre>

<p>Aunque no está explícito en el código anterior, <code>NSURLSession</code> usa implícitamente un <em>thread</em> adicional para no bloquear la interfaz de usuario. Además fíjate en que es <em>asíncrono</em>: nos avisa de cuándo ha respondido el servidor llamando al bloque <code>completionHandler</code>.</p>

<p>Si ejecutas ahora la aplicación e introduces una ciudad en el campo de texto, en la consola de depuración debería aparecer el JSON que nos está enviando Openweather. Comprueba que efectivamente aparecen datos.</p>

<blockquote>
<p>Al colocar el cursor en el campo de texto verás que aparece el teclado típico del móvil, y también verás que no se puede quitar aunque pulses en otra parte. Veremos cómo se hace por código, pero por ahora es más sencillo que en la ventana del simulador selecciones el menú de <code>Hardware &gt; Keyboard</code> y selecciones la opción <code>Toggle Sofware Keyboard</code> para ver/dejar de ver el teclado en pantalla.</p>

<p>Para poder teclear con el teclado del ordenador en vez de tener que pulsar las teclas en pantalla, marca la opción <code>Hardware &gt; Keyboard &gt; Connect Hardware Keyboard</code></p>
</blockquote>

<h3>Mostrar el tiempo en modo texto (1 punto)</h3>

<p>Si te fijas en el JSON que envía el servidor, verás que es un objeto complejo que a su vez tiene dentro otro objeto llamado <code>weather</code> con la descripción del tiempo que hace ahora mismo. A su vez, este <code>weather</code> tiene dentro un array de un solo objeto que es en realidad el que contiene los datos. La descripción en modo texto está en el campo <code>description</code>. Por tanto, para llegar a la descripción haríamos</p>

<pre><code>NSString *descripcion = json[@&quot;weather&quot;][0][@&quot;description&quot;];
</code></pre>

<blockquote>
<p>Sí. El formato es complicado. Las quejas a Openweather, por favor.</p>
</blockquote>

<p><strong>Añade el código necesario para que la descripción aparezca en pantalla como texto de la etiqueta</strong> que has creado antes. Examina el código que has copiado y piensa dónde tienes que introducir las instrucciones. MUY IMPORTANTE: recuerda que <em>las operaciones que actualizan la interfaz tienen que ejecutarse en el </em>thread<em> principal</em>. Consulta las transparencias y/o apuntes para ver cómo obtener acceso a la <em>cola de operaciones principal</em>.</p>

<h3>Mostrar el tiempo en modo imagen (1 punto)</h3>

<p>El API también devuelve el nombre de un icono que representa visualmente el estado del tiempo. Los iconos están en Internet y son accesibles concatenando una URL fija (<code>http://openweathermap.org/img/w/</code>)+el nombre del icono+<code>.png</code>. Por ejemplo si el API nos dice que el icono es <code>10d</code> la URL final será <code>http://openweathermap.org/img/w/10d.png</code>.</p>

<p>El siguiente código hace una petición a la URL del icono y crea una imagen en memoria (un <code>UIImage</code>, no se verá todavía en pantalla, solo está en memoria).</p>

<pre><code>NSString *cadImg = [NSString stringWithFormat:@&quot;http://openweathermap.org/img/w/%@.png&quot;, json[@&quot;weather&quot;][0][@&quot;icon&quot;]];
NSURL *urlImg = [NSURL URLWithString:cadImg];
NSData *dataImg = [NSData dataWithContentsOfURL:urlImg];
if (dataImg) {
    //Si hemos llegado hasta aquí, los datos se han cargado OK.
    //Creamos la imagen en memoria
    UIImage *img = [[UIImage alloc] initWithData:dataImg];
    NSLog(@&quot;Imagen cargada con éxito&quot;);
}
</code></pre>

<p><strong>Inserta el código anterior en el sitio apropiado</strong>. Comprueba que aparece el mensaje en la consola indicando que la imagen se ha cargado con éxito. </p>

<p>Una vez tengas esto funcionando, <strong>añade el código necesario para que la imagen se haga visible en pantalla</strong>. Para ello tendrás que asignar el <code>UIImage</code> creado a la propiedad <code>image</code> del <em>outlet</em> con la imagen. Recuerda que al ser una operación que actualiza el interfaz gráfico, esta asignación debes ejecutarla en la cola de operaciones principal. </p>

</body>
</html>

